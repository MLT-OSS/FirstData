# DataSource Hub MCP - 检索算法说明

本文档详细说明了 DataSource Hub MCP 服务器的数据源检索机制和相关性评分算法。

## 目录

- [查询处理](#查询处理)
- [相关性评分规则](#相关性评分规则)
- [匹配逻辑](#匹配逻辑)
- [过滤与排序](#过滤与排序)
- [示例分析](#示例分析)
- [优势与局限](#优势与局限)

---

## 查询处理

**代码位置：** `server_http.py:124-125`

```python
query_lower = query.lower()
query_terms = set(query_lower.split())
```

### 处理步骤

1. **大小写标准化**：将查询转换为小写，实现不区分大小写的搜索
2. **分词处理**：按空格拆分查询为多个词条（terms）
3. **去重处理**：使用 set 去除重复词条

**示例：**
- 输入查询：`"Youth Unemployment China USA"`
- 处理后：`{"youth", "unemployment", "china", "usa"}`

---

## 相关性评分规则

检索系统在 **7 个字段**中搜索匹配，每个字段有不同的权重分值。

### 评分权重表

| 字段类型 | 权重分值 | 代码位置 | 说明 |
|---------|---------|---------|------|
| 数据源名称（完全匹配） | +10 分 | `server_http.py:139-140` | 查询字符串完整包含在名称中 |
| 数据源名称（部分匹配） | +5 分 | `server_http.py:141-142` | 任意查询词条匹配名称 |
| 描述 | +3 分 | `server_http.py:144-150` | 在描述文本中找到匹配 |
| 标签 | +2 分/标签 | `server_http.py:152-156` | 每个匹配的标签可累加 |
| 领域 | +2 分/领域 | `server_http.py:158-162` | 每个匹配的主题领域可累加 |
| 组织名称 | +2 分 | `server_http.py:173-176` | 机构名称匹配 |
| 数据内容 | +1 分/内容 | `server_http.py:164-171` | 每条匹配的数据内容可累加 |

### 详细说明

#### 1. 数据源名称（最高优先级）

**检索字段：**
- `name.en`（英文名称）
- `name.zh`（中文名称）

**评分规则：**

**完全匹配 (+10分)**
```python
if query_lower in name_en.lower() or query_lower in name_zh.lower():
    score += 10
```

- **示例：** 查询 `"World Bank"`，数据源名称为 `"World Bank Open Data"` → 获得 10 分

**部分匹配 (+5分)**
```python
elif contains_term(name_en) or contains_term(name_zh):
    score += 5
```

- **示例：** 查询 `"World Bank data"`，名称包含 "World" 或 "Bank" → 获得 5 分

#### 2. 描述 (+3分)

**检索字段：**
- `description.en`（英文描述）
- `description.zh`（中文描述）

**评分规则：**
```python
if contains_term(desc_en) or contains_term(desc_zh):
    score += 3
```

在描述文本中找到任意查询词条即可获得 3 分。

#### 3. 标签 (+2分/每个标签)

**检索字段：**
- `tags[]` 数组

**评分规则：**
```python
for tag in tags:
    if contains_term(tag):
        score += 2
```

每个匹配的标签加 2 分，可以累加。

**示例：**
- 查询：`"unemployment China"`
- 标签：`["unemployment", "labor", "China", "statistics"]`
- 得分：2 + 2 = 4 分（两个标签匹配）

#### 4. 领域 (+2分/每个领域)

**检索字段：**
- `coverage.domains[]`

**常见领域：**
- `economics`（经济）
- `health`（健康）
- `environment`（环境）
- `finance`（金融）
- `education`（教育）
- `energy`（能源）
- 等等...

**评分规则：**
```python
domains = datasource.get('coverage', {}).get('domains', [])
for domain in domains:
    if contains_term(domain):
        score += 2
```

每个匹配的领域加 2 分，可以累加。

#### 5. 数据内容 (+1分/每条内容)

**检索字段：**
- `data_content.en[]`（英文内容描述）
- `data_content.zh[]`（中文内容描述）

**评分规则：**
```python
for content in content_en + content_zh:
    if contains_term(content):
        score += 1
```

每个匹配的数据内容描述加 1 分，可以累加。

#### 6. 组织名称 (+2分)

**检索字段：**
- `organization.name`

**评分规则：**
```python
org_name = datasource.get('organization', {}).get('name', '')
if contains_term(org_name):
    score += 2
```

机构名称匹配获得 2 分。

**示例：**
- 查询：`"World Bank"`
- 组织名称：`"The World Bank Group"` → 获得 2 分

---

## 匹配逻辑

**代码位置：** `server_http.py:128-132`

```python
def contains_term(text) -> bool:
    if not text or not isinstance(text, str):
        return False
    text_lower = text.lower()
    return any(term in text_lower for term in query_terms) or query_lower in text_lower
```

### 匹配规则

1. **OR 逻辑**：只要**任意一个**查询词条出现即算匹配
2. **子串匹配**：支持部分匹配
   - 查询 `"employ"` 可以匹配 `"employment"`
   - 查询 `"econ"` 可以匹配 `"economics"`
3. **完整查询匹配**：同时检查完整查询字符串是否出现

### 匹配示例

| 查询 | 文本 | 是否匹配 | 说明 |
|------|------|---------|------|
| `"unemployment China"` | `"Youth unemployment in China"` | ✅ 是 | 包含 "unemployment" 和 "China" |
| `"employ"` | `"Employment Statistics"` | ✅ 是 | "employ" 是 "Employment" 的子串 |
| `"bank data"` | `"World Bank Open Data"` | ✅ 是 | 包含 "bank" 和 "data" |
| `"apple"` | `"Orange juice production"` | ❌ 否 | 无任何词条匹配 |

---

## 过滤与排序

### 1. 最低相关性阈值

**代码位置：** `server_http.py:440-444`

```python
MIN_RELEVANCE_THRESHOLD = 5.0  # 最低相关性阈值

for ds in all_datasources:
    relevance = _calculate_relevance_score(ds, params.query)
    if relevance >= MIN_RELEVANCE_THRESHOLD:  # 过滤低相关性匹配
        scored_datasources.append({...})
```

**只有得分 ≥ 5 分的数据源才会被返回**，这样可以过滤掉弱相关结果。

### 2. 排序规则

**代码位置：** `server_http.py:455-459`

```python
scored_datasources.sort(
    key=lambda x: (x['relevance_score'], x['quality_score']),
    reverse=True
)
```

**双重排序标准：**

1. **主要排序**：按相关性分数（relevance_score）降序
2. **次要排序**：当相关性分数相同时，按质量分数（quality_score）降序

**质量分数计算：** 6 个质量维度的平均值
- Authority Level（权威性等级）
- Methodology Transparency（方法论透明度）
- Update Timeliness（更新及时性）
- Data Completeness（数据完整性）
- Documentation Quality（文档质量）
- Citation Count（引用次数）

### 3. 结果限制

- **默认返回**：前 10 条结果
- **可调范围**：通过 `limit` 参数设置（1-50）
- **字符限制**：总响应不超过 25,000 字符，超出时自动截断

---

## 示例分析

### 查询案例：`"unemployment China"`

假设有以下两个数据源参与检索：

#### 数据源 A：中国就业统计局

```json
{
  "name": {
    "en": "China Employment Statistics",
    "zh": "中国就业统计局"
  },
  "description": {
    "en": "Official unemployment data from China"
  },
  "tags": ["unemployment", "China", "labor", "statistics"],
  "coverage": {
    "domains": ["economics", "labor"]
  },
  "organization": {
    "name": "National Bureau of Statistics of China"
  },
  "data_content": {
    "en": ["unemployment rate", "job market data"]
  }
}
```

#### 数据源 B：世界银行开放数据

```json
{
  "name": {
    "en": "World Bank Open Data"
  },
  "description": {
    "en": "Free access to global economic indicators"
  },
  "tags": ["economics", "global", "development"],
  "coverage": {
    "domains": ["economics", "development"]
  },
  "organization": {
    "name": "World Bank"
  }
}
```

### 评分计算

| 字段 | 数据源 A | 数据源 B | 说明 |
|------|---------|---------|------|
| **名称** | 部分匹配：`China` (+5分) | 无匹配 (0分) | A 的名称包含 "China" |
| **描述** | 匹配：`unemployment`, `China` (+3分) | 无匹配 (0分) | A 的描述包含两个查询词 |
| **标签** | 匹配：`unemployment`, `China` (+4分) | 无匹配 (0分) | A 有 2 个标签匹配 |
| **领域** | 无匹配 (0分) | 无匹配 (0分) | 都不包含查询词 |
| **组织名称** | 匹配：`China` (+2分) | 无匹配 (0分) | A 的组织名包含 "China" |
| **数据内容** | 匹配：`unemployment` (+1分) | 无匹配 (0分) | A 的内容包含 "unemployment" |
| **总分** | **15 分** | **0 分** | A 远高于阈值(5分)，B 低于阈值 |

### 结果

- **数据源 A** 总分 15 分，**会被返回并排在首位**
- **数据源 B** 总分 0 分，**不会被返回**（低于阈值 5 分）

---

## ⚠️ 局限

1. **无语义理解**
   - 纯关键词匹配，不理解查询意图
   - 无法处理同义词：`"job"` 和 `"employment"` 被视为不同词
   - 无法处理缩写：`"GDP"` 和 `"Gross Domestic Product"` 不匹配

2. **不支持高级查询语法**
   - 不支持布尔操作符（AND, OR, NOT）
   - 不支持短语精确匹配（如 `"exact phrase"`）
   - 不支持通配符或正则表达式

3. **固定权重**
   - 权重无法根据查询类型动态调整
   - 某些场景可能需要调整权重策略

4. **子串匹配可能误判**
   - `"chin"` 会匹配 `"China"` 和 `"machine"`
   - 短查询词可能引入噪音

5. **无相关性反馈**
   - 无法根据用户反馈优化排序
   - 无点击率或转化率数据辅助排序

### 🔮 潜在改进方向

1. **引入向量检索**
   - 使用 embedding 模型理解语义
   - 支持同义词和概念匹配

2. **查询扩展**
   - 自动添加同义词、缩写
   - 领域词典支持

3. **动态权重**
   - 根据查询类型调整字段权重
   - 机器学习优化排序模型

4. **查询语法增强**
   - 支持布尔操作符
   - 支持字段限定查询（如 `name:"World Bank"`）

5. **个性化排序**
   - 基于用户历史行为调整排序
   - 协同过滤推荐相关数据源

---

## 代码参考

完整的评分算法实现请参考：
- **文件：** `server_http.py`
- **函数：** `_calculate_relevance_score()` (第 104-178 行)
- **调用：** `datasource_search_sources()` (第 438-462 行)

---

**文档版本：** v1.0
**最后更新：** 2025-12-17
